@page "/quizes"
@inject Client.IApiClient client
@using Models.Api

<h1>Admin</h1>

@if (quizes == null)
{
    <p><em>Loading ...</em></p>
}
else
{
    @if (!quizes.Any())
    {
        <p><span>There aren't quizes at the moment, add one below</span></p>
    }
    else
    {
        <ul>
            @foreach (var quiz in quizes)
            {
                <li><a onclick="@(() => ToggleQuizFields(quiz))">@quiz.Name</a></li>
            }
        </ul>
    }
    <EditForm OnValidSubmit="@HandleSubmit" Model="@newQuiz">
        <FluentValidationValidator />
        <button class="btn btn-primary" onclick="@(() => ToggleQuizFields())">Add quiz</button>

        <div hidden="@(!showAddQuiz)">
            <EditQuiz quiz="@newQuiz" />
        </div>
        <input type="submit" class="btn btn-success" value="Submit" />
    </EditForm>
}

@functions {
        QuizDto[] quizes;
    private bool showAddQuiz { get; set; } = false;

    public QuizDto newQuiz { get; set; } = new QuizDto { Questions = new List<QuestionDto>() };

    protected override async Task OnInitAsync()
    {
        await GetQuizData();
    }

    async Task<QuizDto[]> GetQuizData()
    {
        quizes = await client.GetAsync<QuizDto[]>("api/quiz");
        Console.WriteLine(quizes[0].Questions.Count);
        return quizes;
    }

    void ToggleQuizFields(QuizDto quiz = null)
    {
        showAddQuiz = true;
        newQuiz = quiz ?? new QuizDto { Questions = new List<QuestionDto>() };
    }

    async Task<bool> HandleSubmit()
    {
        if (showAddQuiz)
        {
            if (newQuiz.Id == 0)
            {
                await client.PutAsync<QuizDto>("api/quiz", newQuiz);
            }
            else
            {
                await client.PostAsync<QuizDto>("api/quiz", newQuiz);
            }

            return true;
        }

        Console.WriteLine("There are no quizes");
        return false;
    }
}